syntax = "proto3";
package sf.v6;

message Crs {
  uint32 srid = 1;
  uint32 scale = 2;
}

message CoordinateQ {
  sint32 x = 1;
  sint32 y = 2;
}

enum GeomType {
  GEOM_UNSPECIFIED = 0;
  POINT = 1;
  MULTIPOINT = 2;
  LINESTRING = 3;
  MULTILINESTRING = 4;
  POLYGON = 5;
  MULTIPOLYGON = 6;
}

/**
 * Stream geometry with packed deltas.
 *
 * dxy is packed sint32:
 *   [dx0, dy0, dx1, dy1, ...]
 *
 * IMPORTANT encoding rule:
 * - Each geometry is encoded relative to (cursor = global_start) at the start.
 *   That avoids huge inter-geometry jumps.
 *
 * Nesting reconstruction:
 * - part_sizes:
 *     LineString: [n]
 *     MultiLineString: [n_line1, n_line2, ...]
 *     Polygon: [n_ring1, n_ring2, ...]
 *     MultiPoint: [n] (optional, but keep it if you like)
 * - poly_ring_counts:
 *     MultiPolygon: [rings_in_poly1, rings_in_poly2, ...]
 *     and part_sizes holds ring sizes in polygon order.
 */
message StreamGeometry {
  GeomType type = 1;

  // packed: [dx0, dy0, dx1, dy1, ...]
  repeated sint32 dxy = 2;

  repeated uint32 part_sizes = 3;
  repeated uint32 poly_ring_counts = 4;
}

message FeatureCollectionStream {
  Crs crs = 1;
  CoordinateQ global_start = 2;
  repeated StreamGeometry geometries = 3;
}

message GeometryCollectionStream {
  Crs crs = 1;
  CoordinateQ global_start = 2;
  repeated StreamGeometry geometries = 3;
}
